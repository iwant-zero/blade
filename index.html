<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>BLADE: HIGH-VISIBILITY</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        canvas { display: block; }

        #ui {
            position: absolute; top: 20px; left: 20px;
            color: #1a1a1a;
            pointer-events: none;
            z-index: 10;
            background: rgba(255, 255, 255, 0.4);
            padding: 15px;
            border-radius: 10px;
        }
        #stats { font-size: 24px; font-weight: 900; margin-bottom: 5px; }
        #score { font-size: 26px; font-weight: 900; margin-top: 10px; color: #003366; }
        #awk-timer { color: #660066; font-size: 22px; font-weight: 900; }

        .bar-container { width: 300px; height: 18px; background: rgba(0,0,0,0.3); border: 2px solid #1a1a1a; margin: 5px 0; }
        #hp-fill { width: 100%; height: 100%; background: #cc0033; transition: 0.1s; }
        #exp-fill { width: 0%; height: 100%; background: #008822; transition: 0.3s; }

        #overlay, #pause-menu {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85);
            display: none; flex-direction: column; align-items: center; justify-content: center; color: #fff; z-index: 100;
        }
        .menu-btn { padding: 15px 40px; background: #1a1a1a; border: 2px solid #fff; font-weight: bold; cursor: pointer; font-size: 20px; margin: 10px; color: #fff; }

        #item-msg {
            position: absolute; top: 25%; left: 50%; transform: translateX(-50%);
            font-size: 45px; font-weight: 900; text-align: center; pointer-events: none;
            z-index: 50; display: none; color: #222; text-shadow: 2px 2px 10px rgba(255,255,255,0.8);
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="stats">LV.1 에테르 기사</div>
        <div class="bar-container"><div id="hp-fill"></div></div>
        <div id="awk-timer" style="display:none;">OVERDRIVE: 10s</div>
        <div id="score">SCORE: 0</div>
        <div class="bar-container" style="height:8px;"><div id="exp-fill"></div></div>
    </div>

    <div id="item-msg"></div>

    <div id="pause-menu">
        <h1>PAUSED</h1>
        <button class="menu-btn" onclick="togglePause()">RESUME</button>
        <button class="menu-btn" onclick="location.reload()">RESTART</button>
    </div>

    <div id="overlay">
        <h1 style="font-size: 60px;">GAME OVER</h1>
        <div id="final-result" style="font-size: 30px; margin-bottom: 20px;"></div>
        <button class="menu-btn" onclick="location.reload()">RETRY</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const hpFill = document.getElementById('hp-fill');
const expFill = document.getElementById('exp-fill');
const itemMsg = document.getElementById('item-msg');
const awkTimerUI = document.getElementById('awk-timer');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const img = {
    p: new Image(), e: new Image(), b: new Image(), bg: new Image(),
    ln: new Image(),
    it_core: new Image(), it_thunder: new Image(), it_heal: new Image()
};
img.p.src = 'assets/player.png';
img.e.src = 'assets/enemy.png';
img.b.src = 'assets/boss.png';
img.bg.src = 'assets/background.png';
img.ln.src = 'assets/lightning.png';
img.it_core.src = 'assets/item_core.png';
img.it_thunder.src = 'assets/item_thunder.png';
img.it_heal.src = 'assets/item_heal.png';

const bgm = new Audio('assets/bgm.mp3'); bgm.loop = true; bgm.volume = 0.4;

let isGameOver = false;
let isPaused = false;
let score = 0;
let level = 1;
let exp = 0;
let coreStack = 0;
let awakeningTimeLeft = 0;
let coreColor = '#0ff';

// 바닥선
const floorY = canvas.height - 100;

const player = {
    x: canvas.width/2, y: floorY - 110, w: 80, h: 110,
    vx: 0, vy: 0, grounded: false, dir: 1, hp: 100, maxHp: 100, baseAtk: 45
};

let enemies = [];
let items = [];
let lightnings = [];
let afterimages = [];
const keys = {};

function togglePause() {
    if(isGameOver) return;
    isPaused = !isPaused;
    document.getElementById('pause-menu').style.display = isPaused ? 'flex' : 'none';
    if(isPaused) bgm.pause();
    else if(bgm.currentTime > 0) bgm.play().catch(()=>{});
}

function showItemNotice(text) {
    itemMsg.innerText = text;
    itemMsg.style.display = 'block';
    itemMsg.style.color = '#1a1a1a';
    setTimeout(() => { itemMsg.style.display = 'none'; }, 2000);
}

function centerX(o){ return o.x + o.w * 0.5; }
function centerY(o){ return o.y + o.h * 0.5; }
function distCenter(a, b){
    return Math.hypot(centerX(a) - centerX(b), centerY(a) - centerY(b));
}
function aabbOverlap(a, b){
    return (a.x < b.x + b.w &&
            a.x + a.w > b.x &&
            a.y < b.y + b.h &&
            a.y + a.h > b.y);
}

// 번개 스폰 (10가닥)
function spawnLightnings() {
    if(isGameOver || isPaused) return;
    for(let i=0; i<10; i++) {
        lightnings.push({ x: Math.random() * canvas.width, y: -200, w: 60, h: canvas.height + 200, life: 75 });
    }
}
setInterval(spawnLightnings, 5000);

function spawnEnemy() {
    if(isGameOver || isPaused) return;

    const isBoss = (level % 10 === 0 && enemies.filter(e => e.isBoss).length === 0);

    if(isBoss) {
        const bs = 1 + (level / 100);
        const bossHp = 2500 * Math.pow(1.7, level/10);

        enemies.push({
            x: canvas.width + 200,
            y: floorY - (230 * bs),
            w: 180 * bs,
            h: 230 * bs,
            hp: bossHp,
            maxHp: bossHp,
            speed: 1.2 + (level/70),
            isBoss: true,
            dead: false
        });

        showItemNotice(`BOSS ALERT: LV.${level}`);
    } else {
        enemies.push({
            x: Math.random() > 0.5 ? -150 : canvas.width + 150,
            y: floorY - 90,
            w: 75, h: 95,
            hp: 100 + (level * 30),
            maxHp: 100 + (level * 30),
            speed: 2.8 + (level * 0.25),
            isBoss: false,
            dead: false
        });
    }
}
setInterval(spawnEnemy, 2000);

function tryDropItem(x, y) {
    if (Math.random() > 0.2) return;
    const r = Math.random();
    let type = (r < 0.2) ? 'CORE' : (r < 0.5) ? 'THUNDER' : 'HEAL';
    items.push({ x, y: floorY - 60, w: 55, h: 55, type });
}

window.onkeydown = (e) => {
    if(e.code === 'KeyP') togglePause();
    keys[e.code] = true;
    if(!isPaused && bgm.paused) bgm.play().catch(()=>{});
};
window.onkeyup = (e) => keys[e.code] = false;

function update() {
    if(isGameOver || isPaused) return;

    if(awakeningTimeLeft > 0) {
        awakeningTimeLeft -= 0.016;
        awkTimerUI.style.display = 'block';
        awkTimerUI.innerText = `OVERDRIVE: ${Math.max(0, awakeningTimeLeft).toFixed(1)}s (x${coreStack})`;
        if(awakeningTimeLeft <= 0) {
            coreStack = 0;
            coreColor = '#0ff';
            awkTimerUI.style.display = 'none';
        }
    }

    // 이동
    if(keys['KeyA']) { player.vx = -9; player.dir = -1; }
    else if(keys['KeyD']) { player.vx = 9; player.dir = 1; }
    else player.vx *= 0.85;

    if(keys['Space'] && player.grounded) { player.vy
